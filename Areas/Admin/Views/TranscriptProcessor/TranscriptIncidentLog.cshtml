@model Abundance_Nk.Web.Areas.Admin.ViewModels.TranscriptRequestViewModel
@using Abundance_Nk.Business
@{
    ViewBag.Title = "Transcript Request";
}


<script src="~/Scripts/DataTables-1.10.15/media/js/jquery.js"></script>
<script src="~/Content/js/bootstrap.min.js"></script>
<link href="~/Scripts/DataTables-1.10.15/media/css/jquery.dataTables.css" rel="stylesheet" />
<script src="~/Scripts/DataTables-1.10.15/media/js/jquery.dataTables.js"></script>
<link href="~/Scripts/DataTables-1.10.15/extensions/Buttons/css/buttons.dataTables.css" rel="stylesheet" />
<script src="~/Scripts/DataTables-1.10.15/extensions/Buttons/js/dataTables.buttons.js"></script>
<script src="~/Scripts/DataTables-1.10.15/extensions/Buttons/js/buttons.colVis.js"></script>
<script src="~/Scripts/DataTables-1.10.15/extensions/Responsive/js/dataTables.responsive.js"></script>
<script src="~/Scripts/DataTables-1.10.15/buttons.flash.min.js"></script>
<script src="~/Scripts/DataTables-1.10.15/buttons.html5.min.js"></script>
<script src="~/Scripts/DataTables-1.10.15/buttons.print.min.js"></script>
<script src="~/Scripts/DataTables-1.10.15/jszip.min.js"></script>
<script src="~/Scripts/DataTables-1.10.15/pdfmake.min.js"></script>
<script src="~/Scripts/DataTables-1.10.15/vfs_fonts.js"></script>
<script src="~/Scripts/sweetalert.min.js"></script>
<link href="~/Content/sweetalert.css" rel="stylesheet" />



<script type="text/javascript">
    var requestId;
    var departmentId;
    $(function () {
        // Log Student Detail from the modal
        $('#log').on('click', function () {
            $('#log').text("loading...");
            $('#log').prop('disabled', true);
                            var email = $("#email").val();
                            var phone = $("#phone").val();
                            var note = $('#note').val();
                            if (email != null && email != "" && email != undefined && requestId > 0 && requestId != undefined) {
                                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("LogTranscriptIncidentRequest")', // we are calling json method
                dataType: 'json',
                data: { email: email, phone: phone, requestId: requestId, note: note, departmentId: departmentId},
                success: function (result) {
                    if (!result.IsError) {
                        $('#admitmodal').modal('toggle');
                        swal("Operation Successful", result.Message, "success");
                        location.reload(true);
                    }
                    else {
                        $('#admitmodal').modal('toggle');
                        swal("Info", result.Message, "error");
                        location.reload(true);
                    }
                },
                error: function(ex) {
                    alert('Failed to Open Ticket.' + ex);
                }
            });
                            }
                            else {
                                swal("Info", "Please, Provide All required detail", "error");
                                $('#log').text("log");
                                $('#log').prop('disabled', false);
                            }
        })



        $.extend($.fn.dataTable.defaults, {
            responsive: false
        });

        $("#myTable").DataTable({
            dom: 'Bfrtip',
            ordering: true,
            buttons: [
                {
                    extend: 'copy',
                    exportOptions: {
                        columns: ':visible',
                        modifier: {
                            orientation: 'landscape'
                        }
                    },
                    orientation: 'landscape'


                },
                {
                    extend: 'csv',
                    exportOptions: {
                        columns: ':visible',
                        modifier: {
                            orientation: 'landscape'
                        }
                    },
                    orientation: 'landscape'

                },
                {
                    extend: 'excel',
                    exportOptions: {
                        columns: ':visible',
                        modifier: {
                            orientation: 'landscape'
                        }
                    },
                    orientation: 'landscape'


                },
                {
                    extend: 'pdf',
                    exportOptions: {
                        columns: ':visible',
                        header: true,
                        modifier:{
                            orientation: 'landscape'
                        }



                    },
                    orientation: 'landscape'


                },
                {
                    extend: 'print',
                    exportOptions: {
                        columns: ':visible',
                        modifier: {
                            orientation: 'landscape'
                        }
                    },
                    orientation: 'landscape'


                }, , 'colvis'
            ]
        });

        $("#submit").click(function () {
            $('#submit').attr('disable', 'disable');
        });
    });
    function logRecord(e,y) {
        requestId = e;
        departmentId = y;
    }
</script>

@if (TempData["Message"] != null)
            {
    @Html.Partial("_Message", (Abundance_Nk.Model.Model.Message)TempData["Message"])
}


<br />
<div class="panel panel-default">
    <div class="panel-heading" style="font:larger">
        TRANSCRIPT INCIDENT LOG
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-body">
                @using (Html.BeginForm("TranscriptIncidentLog", "TranscriptProcessor", new { area = "Admin" }, FormMethod.Post))
                {
                    <div class="row">
                        <div class="col-md-12">
                            <div style="overflow: hidden;">
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            Matric Number: @Html.TextBoxFor(model => model.MatricNo, "", new { @class = "form-control col-md-3", @required = true })
                                        </div>
                                        <div class="col-md-6">
                                            <input type="submit" id="submit" value="Submit" class="btn btn-success mr5" />
                                        </div>

                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

</div>



@if (Model == null || Model.TranscriptRequests == null) { return; }

@if (Model != null && Model.TranscriptRequests != null)
{
    <div class="col-sm-12" style="padding: 20px;">

        <div class="alert alert-success fade in nomargin">
            <h3 style="text-align: center">LOG REQUEST</h3>
        </div>

        <table class="table table-responsive table-bordered table-striped table-hover" id="myTable">
            <thead>
                <tr>
                    <th>
                        SN
                    </th>
                    <th>
                        STUDENT NAME
                    </th>
                    <th>
                        MATRIC NO.
                    </th>
                    <th>
                        DEPARTMENT
                    </th>
                    <th>
                        DESTINATION ADDRESS
                    </th>

                    <th>
                        PAYMENT DATE
                    </th>
                    <th>
                        STATUS
                    </th>
                    <th>
                    </th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.TranscriptRequests.Count; i++)
                {
                    int sn = i + 1;
                    var pid = Model.TranscriptRequests[i].payment.Id;
                    var status = Model.TranscriptRequests[i].transcriptStatus.TranscriptStatusId == 5 ? "Dispatched" : "Processing";
                    PaymentEtranzactLogic paymentEtranzactLogic = new PaymentEtranzactLogic();
                    PaymentInterswitchLogic paymentInterswitchLogic = new PaymentInterswitchLogic();
                    var paymentEtranzact = paymentEtranzactLogic.GetModelsBy(x => x.Payment_Id == pid).FirstOrDefault();
                    var paymentInterswitch = paymentInterswitchLogic.GetModelsBy(x => x.Payment_Id == pid).FirstOrDefault();
                    var amountPaid = paymentEtranzact != null ? paymentEtranzact.TransactionAmount : paymentInterswitch.Amount;
                    var paymentDate = paymentEtranzact != null ? paymentEtranzact.TransactionDate : paymentInterswitch.TransactionDate;
                    var Department = Model.StudentLevels[0] != null ? Model.StudentLevels[0].Department.Name.ToUpper() : "";
                    <tr>
                        <td class="col-lg-1 col-md-1 col-sm-1">
                            @sn
                        </td>
                        <td class="col-lg-3 col-md-3 col-sm-3">
                            @Model.TranscriptRequests[i].student.FullName
                        </td>
                        <td class="col-lg-3 col-md-3 col-sm-3">
                            @Model.TranscriptRequests[i].student.MatricNumber
                        </td>
                        <td class="col-lg-3 col-md-3 col-sm-3">
                            @Department
                        </td>
                        <td class="col-lg-3 col-md-3 col-sm-3">
                            @Model.TranscriptRequests[i].DestinationAddress
                        </td>
                        <td class="col-lg-3 col-md-3 col-sm-3">
                            @paymentDate
                        </td>
                        <td class="col-lg-3 col-md-3 col-sm-3">
                            @status
                        </td>
                        <td>
                            <button class="btn btn-success" data-toggle="modal" data-target="#admitmodal" onclick=logRecord(@Model.TranscriptRequests[i].Id,@Model.StudentLevels[0].Department.Id) id="@Model.TranscriptRequests[i].Id +"-btnId"">Log</button>

                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!----------------------------------ADMIT MODAL------------------------------------>
<div class="modal fade" id="admitmodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">ENTER DETAIL</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class = "control-label">Email:</label>
                    <input type="email" class = "form-control" id="email" required />
                    <label class="control-label">Phone:</label>
                    <input type="tel" class="form-control" id="phone" />
                    <label class="control-label">Note:</label>
                    <textarea type="text" class="form-control" id="note" maxlength="180"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="log">LOG</button>
            </div>
        </div>
    </div>
</div>

